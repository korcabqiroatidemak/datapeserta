<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DATA PESERTA (F4)</title>
<style>
/* ================= LAYOUT BODY ================= */
body {
    font-family: 'Times New Roman', Times, serif;
    background-color: #525659;
    margin: 0; padding: 20px 0;
    display: flex; flex-direction: column; align-items: center;
    min-height: 100vh;
}

/* ===== CONTROL PANEL ===== */
.control-panel {
    background-color: #fff; 
    padding: 20px 25px; 
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3); 
    margin-bottom: 25px;
    width: 215mm; /* sesuai F4 */
    box-sizing: border-box;
    display: flex; flex-direction: column; gap: 15px;
}

/* Header panel */
.panel-header {
    display: flex; gap: 15px; align-items: flex-end;
}
.panel-header > div { flex: 1; display: flex; flex-direction: column; gap: 5px; }
.panel-header input, .panel-header select {
    padding: 7px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%;
}

/* Gelombang-Shift checkbox */
#container-shift-checkbox {
    flex: 1;
    border: 1px solid #e0e0e0; 
    background: #fafafa; 
    border-radius: 4px;
    padding: 10px;
    display: grid;
    grid-template-rows: repeat(3, auto); /* 3 baris */
    grid-auto-flow: column;
    gap: 8px 20px;
    overflow-x: auto;
    overflow-y: hidden;
}
#container-shift-checkbox .cb-item { white-space: nowrap; display: flex; align-items: center; gap: 5px; font-size: 13px; font-family: Arial, sans-serif; }
#container-shift-checkbox input { margin: 0; cursor: pointer; }

/* Generate button */
.btn-generate { 
    background-color: #28a745; color: white; border: none; padding: 12px; 
    border-radius: 4px; cursor: pointer; font-weight: bold; font-family: Arial, sans-serif;
    width: 100%; font-size: 15px; text-transform: uppercase; letter-spacing: 0.5px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: all 0.2s;
}
.btn-generate:hover { background-color: #218838; transform: translateY(-1px); }

/* ===== PAGE CONTAINER (F4) ===== */
.page-container {
    background-color: white; 
    width: 215mm; height: 330mm; 
    margin: 0 auto 0 auto; 
    box-shadow: 0 6px 12px rgba(0,0,0,0.3);
    box-sizing: border-box; 
    padding: 10mm 15mm 15mm 15mm; 
    display: flex; flex-direction: column; position: relative;
}

@page { size: 215mm 330mm; margin: 0; }
@media print {
    body { background: none; padding: 0; display: block; }
    .control-panel, #loading, #welcome-msg { display: none !important; }
    .page-container { margin: 0; box-shadow: none; border: none; page-break-after: always; padding: 10mm 15mm 15mm 15mm; }
}

/* ===== HEADER PAGE ===== */
.page-header {
    text-align: center; margin-bottom: 10px;
}
.page-header .title { font-size: 16pt; font-weight: bold; text-transform: uppercase; margin-bottom: 5px; }
.page-header .periode { font-size: 12pt; font-weight: normal; margin-bottom: 8px; }
.page-header .gel-shift { font-size: 11pt; font-weight: bold; }

/* ===== GRID PESERTA ===== */
.split-table-container { display: flex; gap: 10mm; flex: 1; margin-bottom: 5px; }
.table-column { flex: 1; display: flex; flex-direction: column; }
table { width: 100%; border-collapse: collapse; font-size: 11pt; }
th { border: 1px solid #000; padding: 5px; background-color: #f0f0f0; font-weight: bold; text-align: center; height: 30px; }
td { border: 1px solid #000; padding: 0 5px; vertical-align: middle; }
.col-no { width: 20%; text-align: center; font-weight: bold; }
.col-nama { width: 80%; }

/* Footer tanda tangan */
.footer-legal { display: flex; justify-content: flex-end; font-size: 11pt; margin-top: 10px; }
.sign-box { width: 250px; text-align: center; }
.sign-space { height: 12mm; } 
.sign-name { text-decoration: underline; font-weight: bold; }
.sign-hint { font-size: 9pt; color: rgba(0,0,0,0.4); font-style: italic; margin-top: 2px; }
</style>
</head>
<body>

<div class="control-panel">
    <div class="panel-header">
        <div>
            <label>Judul</label>
            <input type="text" id="inp-judul" value="DATA PESERTA">
        </div>
        <div>
            <label>Periode</label>
            <input type="text" id="inp-periode" value="Rojab 1447 H">
        </div>
        <div>
            <label>Tahun</label>
            <input type="text" id="inp-tahun" value="1447 H">
        </div>
    </div>

    <div>
        <h4>Gelombang & Shift</h4>
        <div id="container-shift-checkbox">
            <div style="padding: 10px; color: #999; font-size: 12px; text-align: center;">Memuat data...</div>
        </div>
    </div>

    <button class="btn-generate" onclick="generateBatchDocs()">GENERATE DOKUMEN</button>
</div>

<div id="loading" style="text-align:center;margin-top:50px;color:white;"><h3>Sedang Memuat Data...</h3></div>
<div id="welcome-msg" style="text-align:center;color:white;margin-top:20px;font-family:Arial;">Siap untuk mencetak!</div>
<div id="main-output"></div>

<script>
const SHEET_ID = '1eIcvIgCLWG3F9jQdsw5XN9llOsK2PoYWKUg1qaQJyyA';
const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Biodata Cek`;

let rawData = [];
let groupedData = [];
let availableShifts = [];

async function init() {
    try {
        const res = await fetch(SHEET_URL);
        const txt = await res.text();
        processData(txt);
        document.getElementById('loading').style.display = 'none';
    } catch (err) {
        alert("Gagal load data: " + err.message);
    }
}

function processData(csvText) {
    const rows = csvText.trim().split('\n').filter(r => r.trim().length>0);
    const headers = rows[0].split(',').map(h => h.trim().replace(/"/g,''));
    rawData = [];
    for(let i=1;i<rows.length;i++){
        const r = rows[i].match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
        let p={};
        r.forEach((val, idx)=>{p[headers[idx]] = val ? val.trim().replace(/"/g,'') : '';});
        p['INT_NO'] = parseInt(p['Nomor']) || i;
        rawData.push(p);
    }

    groupedData = {};
    rawData.forEach(p=>{
        const key = `${p['Gelombang'] || '-'}-${p['Shift'] || '-'}`;
        if(!groupedData[key]) groupedData[key]=[];
        groupedData[key].push(p);
    });

    availableShifts = Object.keys(groupedData).sort();
    renderShiftCheckboxes();
}

function renderShiftCheckboxes() {
    const container = document.getElementById('container-shift-checkbox');
    container.innerHTML = '';
    availableShifts.forEach(key=>{
        const [g,s] = key.split('-');
        const count = groupedData[key].length;
        const div = document.createElement('label');
        div.className='cb-item';
        div.innerHTML=`<input type="checkbox" name="chk-shift" value="${key}"> Gel ${g} - Shift ${s} (${count})`;
        container.appendChild(div);
    });
}

function generateBatchDocs(){
    const output=document.getElementById('main-output');
    output.innerHTML='';
    const judul=document.getElementById('inp-judul').value;
    const periode=document.getElementById('inp-periode').value;

    const chkShifts=document.querySelectorAll('input[name="chk-shift"]:checked');
    if(chkShifts.length===0){alert("Pilih Gelombang & Shift!"); return;}

    let globalPageCounter=1;

    chkShifts.forEach(cb=>{
        const key=cb.value;
        const participants=groupedData[key].sort((a,b)=>a.INT_NO-b.INT_NO);
        const [gel, shift]=key.split('-');

        const firstPageRows=10; // 2x5
        const nextPageRows=12; // 2x6
        let start=0;

        // halaman pertama
        const firstChunk=participants.slice(start, firstPageRows);
        const pageHTML=createPage(firstChunk, {judul,periode,gel,shift});
        output.appendChild(pageHTML);
        globalPageCounter++; start=firstPageRows;

        // halaman berikutnya
        while(start<participants.length){
            const chunk=participants.slice(start,start+nextPageRows);
            const pageHTML2=createPage(chunk, {judul,periode,gel,shift});
            output.appendChild(pageHTML2);
            globalPageCounter++; start+=nextPageRows;
        }
    });
}

function createPage(data,cfg){
    const div=document.createElement('div');
    div.className='page-container';

    const makeRows=(arr,max)=>{
        let h='';
        arr.forEach(p=>h+=`<tr><td class="col-no">${p.Nomor}</td><td class="col-nama">${p.Nama}</td></tr>`);
        for(let k=0;k<(max-arr.length);k++) h+=`<tr><td class="col-no">&nbsp;</td><td class="col-nama"></td></tr>`;
        return h;
    };

    const leftRows=makeRows(data.slice(0,Math.ceil(data.length/2)),Math.ceil(data.length/2));
    const rightRows=makeRows(data.slice(Math.ceil(data.length/2)),Math.floor(data.length/2));

    div.innerHTML=`
        <div class="page-header">
            <div class="title">${cfg.judul}</div>
            <div class="periode">${cfg.periode}</div>
            <div class="gel-shift">Gel ${cfg.gel} - Shift ${cfg.shift}</div>
        </div>
        <div class="split-table-container">
            <div class="table-column"><table><thead><tr><th>NO</th><th>NAMA</th></tr></thead><tbody>${leftRows}</tbody></table></div>
            <div class="table-column"><table><thead><tr><th>NO</th><th>NAMA</th></tr></thead><tbody>${rightRows}</tbody></table></div>
        </div>
        <div class="footer-legal">
            <div class="sign-box">
                <div class="sign-place">Penguji,</div>
                <div class="sign-space"></div>
                <div class="sign-name">_______________________</div>
                <div class="sign-hint">(tanda tangan dan nama terang)</div>
            </div>
        </div>
    `;
    return div;
}

init();
</script>
</body>
</html>
