<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>EBTAQ Paging Final</title>

<style>
/* =================== GLOBAL =================== */
body {
    margin: 0;
    padding: 20px 0;
    background: #666;
    font-family: "Times New Roman", serif;
}

.page {
    width: 215mm;
    height: 330mm;
    background: white;
    margin: 0 auto 20px auto;
    padding: 12mm 15mm;
    box-sizing: border-box;
    position: relative;
    page-break-after: always;
}

@page {
    size: 215mm 330mm;
    margin: 0;
}

@media print {
    body { background: none; padding: 0; }
    .page { margin: 0; }
}

/* =================== HEADER =================== */
.header {
    text-align: center;
    margin-bottom: 10px;
}

.header h1 {
    font-size: 18pt;
    margin: 0;
}

.header h2 {
    font-size: 14pt;
    margin: 3px 0;
}

.info {
    display: flex;
    justify-content: space-between;
    font-size: 11pt;
    margin-bottom: 8px;
}

.info div {
    width: 48%;
}

/* =================== TABLE =================== */
.table-wrap {
    display: flex;
    gap: 10mm;
}

table {
    width: 100%;
    border-collapse: collapse;
    font-size: 11pt;
}

th, td {
    border: 1px solid #000;
    padding: 4px;
    height: 28px;
}

th {
    text-align: center;
    background: #eee;
}

.col-no {
    width: 20%;
    text-align: center;
    font-weight: bold;
}

/* =================== FOOTER =================== */
.footer-label {
    position: absolute;
    bottom: 8mm;
    right: 15mm;
    font-size: 9pt;
    font-style: italic;
    color: #444;
}
</style>
</head>

<body>
<div id="output"></div>

<script>
/* =================== CONFIG =================== */
const SHEET_ID = "1eIcvIgCLWG3F9jQdsw5XN9llOsK2PoYWKUg1qaQJyyA";
const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Biodata Cek`;

/* =================== INIT =================== */
fetch(SHEET_URL)
    .then(r => r.text())
    .then(csv => generate(parseCSV(csv)));

/* =================== CSV PARSER =================== */
function parseCSV(text) {
    const rows = text.trim().split("\n");
    const headers = rows.shift().split(",").map(h => h.replace(/"/g,""));

    return rows.map(r => {
        const cols = r.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
        let obj = {};
        headers.forEach((h,i)=>{
            obj[h] = cols[i]?.replace(/"/g,"").trim() || "";
        });
        return obj;
    });
}

/* =================== GENERATOR =================== */
function generate(data) {
    const out = document.getElementById("output");

    /* GROUP PER SHIFT */
    const groups = {};
    data.forEach(p=>{
        const key = `${p.Gelombang}-${p.Shift}`;
        if(!groups[key]) groups[key]=[];
        groups[key].push(p);
    });

    Object.keys(groups).forEach(key=>{
        const [gel, shift] = key.split("-");
        const peserta = groups[key].sort((a,b)=>a.NOMOR-b.NOMOR);

        /* HALAMAN 1 */
        createPage(
            peserta.slice(0,10),
            {header:true, gel, shift, page:1}
        );

        /* HALAMAN LANJUTAN */
        let sisa = peserta.slice(10);
        let pageNum = 2;

        while(sisa.length){
            createPage(
                sisa.splice(0,12),
                {header:false, gel, shift, page:pageNum}
            );
            pageNum++;
        }
    });
}

/* =================== PAGE BUILDER =================== */
function createPage(data, cfg) {
    const page = document.createElement("div");
    page.className = "page";

    if(cfg.header){
        page.innerHTML += `
        <div class="header">
            <h1>BLANGKO REKAP PENILAIAN</h1>
            <h2>Evaluasi Belajar Tahap Akhir Qiroati</h2>
        </div>
        <div class="info">
            <div>Gelombang : ${cfg.gel}</div>
            <div>Shift : ${cfg.shift}</div>
        </div>
        `;
    }

    const rowsPerCol = cfg.header ? 5 : 6;

    const left = data.slice(0, rowsPerCol);
    const right = data.slice(rowsPerCol, rowsPerCol*2);

    page.innerHTML += `
    <div class="table-wrap">
        ${makeTable(left, rowsPerCol)}
        ${makeTable(right, rowsPerCol)}
    </div>
    `;

    if(!cfg.header){
        page.innerHTML += `
        <div class="footer-label">
            Gel ${cfg.gel} Shift ${cfg.shift} â€“ Halaman ${cfg.page}
        </div>`;
    }

    document.getElementById("output").appendChild(page);
}

/* =================== TABLE MAKER =================== */
function makeTable(arr, max) {
    let rows = "";
    arr.forEach(p=>{
        rows += `
        <tr>
            <td class="col-no">${p.NOMOR}</td>
            <td></td>
        </tr>`;
    });
    for(let i=arr.length;i<max;i++){
        rows += `
        <tr>
            <td class="col-no">&nbsp;</td>
            <td></td>
        </tr>`;
    }

    return `
    <table>
        <thead>
            <tr>
                <th class="col-no">NO</th>
                <th>NILAI</th>
            </tr>
        </thead>
        <tbody>${rows}</tbody>
    </table>`;
}
</script>
</body>
</html>
