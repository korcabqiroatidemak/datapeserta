<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DATA PESERTA - F4</title>
<style>
/* ===== RESET & HALAMAN ===== */
@page { size: 215mm 330mm; margin: 10mm; }
body { margin:0; font-family: 'Times New Roman', serif; background:#eee; display:flex; flex-direction:column; align-items:center; }

.control-panel {
    background:white; padding:20px; border-radius:8px; box-shadow:0 4px 15px rgba(0,0,0,0.3);
    width: 215mm; box-sizing:border-box; margin-top:10px; display:flex; flex-direction:column; gap:15px;
}

.control-row { display:flex; gap:15px; align-items:center; }
.control-row label { width:80px; font-weight:bold; font-size:12pt; }

input[type=text], select { flex:1; padding:6px 10px; border:1px solid #ccc; border-radius:4px; font-size:12pt; }

.checkbox-container {
    display:grid;
    grid-auto-flow: column;
    grid-template-rows: repeat(3, auto);
    gap:8px 25px;
    overflow-x:auto;
    padding:10px;
    border:1px solid #ccc;
    border-radius:4px;
    max-width:100%;
}

.cb-item { display:flex; align-items:center; gap:5px; font-size:11pt; }
.cb-item input { cursor:pointer; }

.btn-generate {
    background:#28a745; color:white; border:none; padding:12px; border-radius:4px; cursor:pointer;
    font-weight:bold; font-size:14pt; letter-spacing:0.5px;
    transition:all 0.2s;
}
.btn-generate:hover { background:#218838; transform:translateY(-1px); }

.page-container {
    width:215mm;
    height:330mm;
    background:white;
    margin:10px auto;
    box-sizing:border-box;
    padding:10mm 15mm;
    display:flex;
    flex-direction:column;
    page-break-after: always;
}

.header {
    text-align:center;
    margin-bottom:5mm;
}
.header h1 { font-size:18pt; margin:0; }
.header h2 { font-size:12pt; margin:2px 0 0 0; }

.grid-container {
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:5mm;
    flex:1;
}

.kartu-mini {
    border:1px solid #000;
    padding:5px;
    display:flex;
    align-items:flex-start;
    font-size:10pt;
    line-height:1.2;
}

.foto-area {
    width:3cm;
    height:4cm;
    flex-shrink:0;
    margin-right:5px;
    display:flex;
    align-items:center;
    justify-content:center;
    border:1px solid #ccc;
    background:#f9f9f9;
}
.foto-area img { width:100%; height:100%; object-fit:cover; }

.info-area { flex:1; display:flex; flex-direction:column; justify-content:flex-start; }
.row-data { display:flex; margin-bottom:2px; }
.label { width:60px; font-weight:bold; flex-shrink:0; }
.separator { width:10px; text-align:center; flex-shrink:0; }
.value { white-space:normal; word-wrap:break-word; }

/* PRINT */
@media print {
    body { background:white; }
    .control-panel { display:none; }
    .page-container { margin:0; box-shadow:none; border:none; height:100vh; }
}
</style>
</head>
<body>

<div class="control-panel">
    <div class="control-row">
        <label>Periode</label>
        <select id="sel-bulan">
            <option>Muharrom</option>
            <option>Shofar</option>
            <option>Rabi'ul Awal</option>
            <option>Rabi'ul Akhir</option>
            <option>Jumadil Awal</option>
            <option>Jumadil Akhir</option>
            <option selected>Rojab</option>
            <option>Sya'ban</option>
            <option>Ramadhan</option>
            <option>Syawal</option>
            <option>Dzulqa'dah</option>
            <option>Dzulhijjah</option>
        </select>
        <input type="text" id="inp-tahun" value="1447 H">
    </div>

    <div>
        <label>Pilih Gelombang-Shift</label>
        <div id="shift-container" class="checkbox-container">
            <div style="padding:10px;color:#999;">Menunggu data...</div>
        </div>
    </div>

    <button class="btn-generate" onclick="generatePages()">GENERATE DOKUMEN</button>
</div>

<div id="main-output"></div>

<script>
const SHEET_ID = '1eIcvIgCLWG3F9jQdsw5XN9llOsK2PoYWKUg1qaQJyyA';
const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Biodata Cek`;

let rawData=[], groupedData={}, availableShifts=[];

async function init() {
    try {
        const res = await fetch(SHEET_URL);
        const txt = await res.text();
        processData(txt);
    } catch(e){ alert("Gagal load data: "+e.message); }
}
function processData(csvText){
    const rows = csvText.trim().split('\n').filter(r=>r.trim().length>0);
    const headers = rows[0].split(',').map(h=>h.trim().replace(/"/g,''));
    rawData=[];
    for(let i=1;i<rows.length;i++){
        const r = rows[i].match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g)||[];
        let p={};
        r.forEach((val,idx)=>{ p[headers[idx]] = val?val.trim().replace(/"/g,''):''; });
        rawData.push(p);
    }
    groupedData={};
    rawData.forEach(p=>{
        const key = `${p['Gelombang'] || '-'}-${p['Shift'] || '-'}`;
        if(!groupedData[key]) groupedData[key]=[];
        groupedData[key].push(p);
    });
    availableShifts=Object.keys(groupedData).sort((a,b)=>{
        const [g1,s1]=a.split('-').map(Number), [g2,s2]=b.split('-').map(Number);
        return g1!==g2?g1-g2:s1-s2;
    });
    renderShiftCheckboxes();
}
function renderShiftCheckboxes(){
    const container = document.getElementById('shift-container');
    container.innerHTML='';
    availableShifts.forEach(key=>{
        const [g,s] = key.split('-');
        const label = `Gel ${g} - Shift ${s}`;
        const count = groupedData[key].length;
        const div = document.createElement('label');
        div.className='cb-item';
        div.innerHTML=`<input type="checkbox" name="chk-shift" value="${key}"> ${label} (${count})`;
        container.appendChild(div);
    });
}

function getDirectDriveUrl(url){ if(!url) return ''; const matchId = url.match(/id=([a-zA-Z0-9_-]+)/); return (matchId&&matchId[1])?`https://lh3.googleusercontent.com/d/${matchId[1]}`:url; }

function generatePages(){
    const mainOutput = document.getElementById('main-output');
    mainOutput.innerHTML='';
    const bulan = document.getElementById('sel-bulan').value;
    const tahun = document.getElementById('inp-tahun').value;
    const chkShifts = document.querySelectorAll('input[name="chk-shift"]:checked');
    if(chkShifts.length===0){ alert("Pilih Gelombang-Shift"); return; }
    chkShifts.forEach(cb=>{
        const key = cb.value;
        const participants = groupedData[key];
        renderShiftPages(participants,key,bulan,tahun);
    });
}

function renderShiftPages(participants,key,bulan,tahun){
    const [gel,shift]=key.split('-');
    const PER_PAGE_FIRST=10, PER_PAGE_NEXT=12;
    let idx=0,pageCount=1;
    while(idx<participants.length){
        const isFirst = (pageCount===1);
        const perPage = isFirst?PER_PAGE_FIRST:PER_PAGE_NEXT;
        const chunk = participants.slice(idx,idx+perPage);
        const pageDiv = document.createElement('div');
        pageDiv.className='page-container';
        if(isFirst){
            const headerDiv = document.createElement('div');
            headerDiv.className='header';
            headerDiv.innerHTML=`<h1>DATA PESERTA</h1><h2>Periode ${bulan} ${tahun} | Gel ${gel} - Shift ${shift}</h2>`;
            pageDiv.appendChild(headerDiv);
        }
        const gridDiv=document.createElement('div');
        gridDiv.className='grid-container';
        chunk.forEach(p=>{
            const card = document.createElement('div'); card.className='kartu-mini';
            const fotoUrl = getDirectDriveUrl(p['Kirim Pas Foto Ukuran PostCard']);
            const nama = (p['Nama Lengkap (Sesuai Akta)']||'-').toUpperCase();
            const id = p['ID Pendaftaran']||'-';
            const ttl = (p['Tempat Lahir']||'')+', '+(p['Tanggal Lahir']||'');
            const jk = p['Jenis Kelamin']||'-';
            const bin = (p['Nama Ayah']||'-').toUpperCase();
            const binti = (p['Nama Ibu']||'-').toUpperCase();
            card.innerHTML=`
                <div class="foto-area"><img src="${fotoUrl}" onerror="this.style.display='none'; this.parentNode.innerText='NO FOTO'"></div>
                <div class="info-area">
                    <div class="row-data"><span class="label">ID</span><span class="separator">:</span><span class="value">${id}</span></div>
                    <div class="row-data"><span class="label">NAMA</span><span class="separator">:</span><span class="value">${nama}</span></div>
                    <div class="row-data"><span class="label">LEMB.</span><span class="separator">:</span><span class="value">${p['Asal Lembaga / TPQ']||'-'}</span></div>
                    <div class="row-data"><span class="label">TTL</span><span class="separator">:</span><span class="value">${ttl}</span></div>
                    <div class="row-data"><span class="label">JK</span><span class="separator">:</span><span class="value">${jk}</span></div>
                    <div class="row-data"><span class="label">BIN</span><span class="separator">:</span><span class="value">${bin}</span></div>
                    <div class="row-data"><span class="label">BINTI</span><span class="separator">:</span><span class="value">${binti}</span></div>
                </div>`;
            gridDiv.appendChild(card);
        });
        pageDiv.appendChild(gridDiv);
        mainOutput.appendChild(pageDiv);
        idx+=perPage; pageCount++;
    }
}

init();
</script>
</body>
</html>
